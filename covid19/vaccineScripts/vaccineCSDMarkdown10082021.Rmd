---
title: "Corvallis School District vaccination estimates"
author: "Peter Banwarth - Benton County Health Department"
date: "10/08/2021"
output:
  rmarkdown::pdf_document:
    fig_caption: yes        
    includes:  
      in_header: my_header.txt
classoption: landscape
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, echo = FALSE, results = "hide", message=FALSE,warning=FALSE}
# libraries
library(sf)
library(tidyverse)
library(tidycensus)
library(ggplot2)
library(data.table)
library(ggmap)
library(RColorBrewer)
library(lubridate)
library(eeptools)
library(kableExtra)
library(scales)


# reading in vaccine data
setwd("L:/Health/CD/Coronavirus - Covid19 - SARS CoV 2/Epi Data/Data - Orpheus Exports/banwarth/raw/alertData/benton")
vax <- readxl::read_xlsx("alertDataBenton.xlsx",
                         col_types = c("numeric","text","text","text","date",rep("skip",26),"date",rep("skip",6),"text","text",rep("skip",5)))

# # temporary dataset for development
# vsave <- vax
# vax <- vax[c(1:100),]

# separate incomplete from complete and recombine into wider format
vaxInc <- vax %>% filter(MFR %in% c("Pfizer","Moderna") & DOSE == 1)
vaxComp <- vax %>% filter(MFR == "Janssen" | DOSE >= 2)

names(vaxInc) <- c("CLIENT_ID","LAST_NAME","FIRST_NAME","MIDDLE_NAME","BIRTHDATE","FIRSTDOSE_DATE","MFR","FIRSTDOSE")
names(vaxComp) <- c("CLIENT_ID","LN","FN","MN","BD","COMPLETEDOSE_DATE","Manu","COMPLETEDOSE")

vaxWide <- data.table(merge(vaxInc,vaxComp, by="CLIENT_ID",all=TRUE))
vaxWide[is.na(vaxWide$LAST_NAME),c("LAST_NAME","FIRST_NAME","MIDDLE_NAME","BIRTHDATE","MFR")] <- vaxWide[is.na(vaxWide$LAST_NAME),c("LN","FN","MN","BD","Manu")]
vaxWide[is.na(vaxWide$COMPLETEDOSE),"COMPLETEDOSE"] <- 0

vax <- vaxWide %>% select(c(CLIENT_ID,LAST_NAME,FIRST_NAME,MIDDLE_NAME,BIRTHDATE,FIRSTDOSE_DATE,MFR,COMPLETEDOSE_DATE,COMPLETEDOSE))

# paste name and DOB
vax$nameDOB <- paste0(vax$LAST_NAME,vax$BIRTHDATE)

# read in student data
student <- readxl::read_excel("csdRE10042021.xlsx",
                              col_types = c("text","text",rep("skip",5),"date","text","text","skip",rep("text",7),rep("skip",8),"text","skip","skip"))

# restrict to only Benton County
countyResidence <- data.table(table(student$`Resident County`))
names(countyResidence) <- c("County of residence","Number of students")
student <- student[student$`Resident County` == "Benton",]

# restrict to students 12 years and older
student <- student[student$DOB<"2009-10-01",]

student$`Legal Last Name` <- toupper(student$`Legal Last Name`)
student$nameDOB <- paste0(student$`Legal Last Name`,student$DOB)

# flag vaccinated students
student$vax <- 0
student[student$nameDOB %in% vax$nameDOB,"vax"] <- 1

vaxRateFun <- function(dt=student,school,race) {
  dt <- dt[dt$'School Name' == school,]
  dt <- dt[dt$'FAFSA Race' == race,]
  
  if(dim(dt)[[1]] > 0) {
  
  t <- data.table("School" = school,
                  "Race/Ethnicity" = race,
                  "Vaccinated" = length(which(dt$vax == 1)),
                  "Unvaccinated" = length(which(dt$vax == 0)),
                  "Number of students" = length(dt$vax),
                  "Vaccination rate (percent)" = length(which(dt$vax == 1))/length(dt$vax))
  
  t$`Vaccination rate (percent)` <- t[,.(percent(`Vaccination rate (percent)`,accuracy = 0.1))]
  return(t)
  }
}

schoolRaceGrid <- expand.grid(unique(student$`School Name`), unique(student$`FAFSA Race`))

listTable <- mapply(vaxRateFun,dt = list(data.table(student)), school = schoolRaceGrid[,1],race = schoolRaceGrid[,2])
school <- do.call(rbind,listTable)
schoolTotal <- school[,-c(2,6)][,lapply(.SD,sum),by=.(School)]
schoolTotal$`Race/Ethnicity` <- "Total"
schoolTotal <- schoolTotal %>% relocate(`Race/Ethnicity`,.after=School)
schoolTotal$`Vaccination rate (percent)` <- schoolTotal$Vaccinated/schoolTotal$`Number of students`
schoolTotal$`Vaccination rate (percent)` <- schoolTotal[,.(percent(`Vaccination rate (percent)`,accuracy = 0.1))]
school <- rbind(school,schoolTotal)
school <- school[order(school$School),]

# Middle school age
middle <- school[school$School %in% c("Cheldelin Middle School","Linus Pauling","Franklin School"),]
middle <- middle[,-c(1,6)][,lapply(.SD,sum),by=.(`Race/Ethnicity`)]
middle$School <- "All middle schools"
middle <- middle %>% relocate(School,.before=`Race/Ethnicity`)
middle$`Vaccination rate (percent)` <- middle$Vaccinated/middle$`Number of students`
middle$`Vaccination rate (percent)` <- middle[,.(percent(`Vaccination rate (percent)`,accuracy = 0.1))]

# High school age
high <- school[school$School %in% c("Corvallis High School","Crescent Valley High School","Corvallis Pathways"),]
high <- high[,-c(1,6)][,lapply(.SD,sum),by=.(`Race/Ethnicity`)]
high$School <- "All high schools"
high <- high %>% relocate(School,.before=`Race/Ethnicity`)
high$`Vaccination rate (percent)` <- high$Vaccinated/high$`Number of students`
high$`Vaccination rate (percent)` <- high[,.(percent(`Vaccination rate (percent)`,accuracy = 0.1))]

# District
district <- school[,-c(1,6)][,lapply(.SD,sum),by=.(`Race/Ethnicity`)]
district$School <- "All middle and high schools"
district <- district %>% relocate(School,.before=`Race/Ethnicity`)
district$`Vaccination rate (percent)` <- district$Vaccinated/district$`Number of students`
district$`Vaccination rate (percent)` <- district[,.(percent(`Vaccination rate (percent)`,accuracy = 0.1))]

# introducing NA for privacy
school[school$`Number of students`<10,c(3:6)] <- NA
middle[middle$`Number of students`<10,c(3:6)] <- NA
high[high$`Number of students`<10,c(3:6)] <- NA
district[district$`Number of students`<9,c(3:6)] <- NA
```

```{r county,echo = FALSE}
countyResidence  %>%
  kbl(caption = "County of residence for CSD students") %>% 
  kable_paper(latex_options = c("HOLD_position"))
```

### Vaccination data is updated through October 3rd, 2021, but is provisional and subject to change. School enrollment data is updated to October 6th and is subject to change.

### Note: Vaccination rates are computed only among students residing in Benton County. Some "school residences" may not match the "vaccination residence", so the computed vaccination rates may be very slight underestimates.

### Note: NA is introduced when the population of that race/ethnicity is 10 or fewer in order to protect the privacy of students, except at the district level, where it is 8 or fewer

```{r middle, echo = FALSE}
school[school$School %in% c("Cheldelin Middle School","Linus Pauling","Franklin School"),] %>%
  kbl(caption = "Vaccination rates at CSD middle schools by race/ethnicity") %>% 
  kable_paper(latex_options = c("HOLD_position"))

middle %>%
  kbl(caption = "Vaccination rates of all CSD middle school students by race/ethnicity") %>% 
  kable_paper(latex_options = c("HOLD_position"))

```

```{r high, echo = FALSE}
school[school$School %in% c("Corvallis High School","Crescent Valley High School","Corvallis Pathways"),] %>%
  kbl(caption = "Vaccination rates at CSD high schools by race/ethnicity") %>% 
  kable_paper(latex_options = c("HOLD_position"))

high %>%
  kbl(caption = "Vaccination rates of all CSD high school students by race/ethnicity") %>% 
  kable_paper(latex_options = c("HOLD_position"))
```

```{r district, echo = FALSE}
school[school$School %in% "Corvallis Online",] %>%
  kbl(caption = "Vaccination rates at Corvallis Online by race/ethnicity") %>% 
  kable_paper(latex_options = c("HOLD_position"))

district %>%
  kbl(caption = "Vaccination rates of all CSD middle and high school students by race/ethnicity") %>% 
  kable_paper(latex_options = c("HOLD_position"))

```

### Note: NA is introduced when the population of that race/ethnicity is 10 or fewer in order to protect the privacy of students, except at the district level, where it is 8 or fewer